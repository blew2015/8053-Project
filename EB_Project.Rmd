---
title: "Final Project"
author: "Hyun Jung (HJ) Koo"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source("data_gen.R") # Data simulation
```

## Data Simulation

### Case 1. Simplest (equal mu for all theta_i)
Let $X_i \sim N(\theta_i, \sigma^2)$ and $\theta_i \sim N(\mu, \tau^2)$. Let $i=1,...N$.

We can simulate 10000 data points and then divide into training (70%) and testing (30%). 

(a) Bayesian case, Let $\theta_i \sim N(\mu,\tau^2)$ (correct prior) where $\mu,\tau^2$ are both known.

(b) Bayesian case, Let $p(\theta_i)=1$ (improper prior). 

(c) Empirical Bayes. $\mu, \tau^2$ are both unknown and will be estimated from the data.

Our goal is to estimate $E(\theta_i|X_i)$, i.e. the posterior mean. 

Sampling in pairs $(X_i, \theta_i)$.
```{r}
norm_pair_gen <- function(n,theta,sigma, mu, tau) {
  pairs_x <- c()
  pairs_theta <- c()
  for (i in 1:n) {
    pairs_x[i] <- rnorm(1, mean = theta, sd = sigma)
    pairs_theta[i] <- rnorm(1, mean = mu, sd = tau)
  }
  pair <- cbind(pairs_x, pairs_theta)
  return(pair)
}
```

```{r}
set.seed(1234)
mu = 0
tau = 1
sigma = 1
theta = 0
n = 10000
norm_1 <- norm_pair_gen(10000, theta, sigma, mu, tau)
norm_1 <- as.data.frame(norm_1)
```

Splitting into training and testing. 
```{r}
set.seed(1234)
sample <- sample(c(TRUE, FALSE), nrow(norm_1), replace=TRUE, prob=c(0.7,0.3))
train  <- norm_1[sample, ]
test   <- norm_1[!sample, ]
```

```{r}
hist(train$pairs_x)
hist(train$pairs_theta)
```


```{r}
xbar <- mean(train$pairs_x)
```


Posterior mean of Bayesian approach (a): $\frac{\tau^2}{\tau^2+\sigma^2}X_i+\frac{\sigma^2}{\tau^2+\sigma^2}\mu$

```{r}
bayes_a_post_mean <- (tau^2/(tau^2+sigma^2))*norm_1$pairs_x + (sigma^2/(tau^2+sigma^2))*mu
```

Posterior mean of Bayesian approach (b): $X_i$

```{r}
bayes_b_post_mean <- norm_1$pairs_x
```

Posterior mean of Empirical Bayes: $(1-\frac{(n-3)\sigma^2}{\sum(X_i-\bar{X})^2})X_i+\frac{(n-3)\sigma^2}{\sum(X_i-\bar{X})^2}\bar{X}$

```{r}
EB_post_mean <- (1-(((n-3)*sigma^2)/sum((norm_1$pairs_x-mean(norm_1$pairs_x))^2)))*norm_1$pairs_x+((((n-3)*sigma^2)/sum((norm_1$pairs_x-mean(norm_1$pairs_x))^2)))*mean(norm_1$pairs_x)
```

Calculating the MSE. The true $\theta_i=\mu=0$

```{r}
MSE_bayes_a <- mean((bayes_a_post_mean)^2)
MSE_bayes_b <- mean((bayes_b_post_mean)^2)
MSE_EB <- mean((EB_post_mean)^2)
```


Now writing a function to do everything together with varying sample sizes.
```{r}

```

### Case 2. Same setup as Case 1 but with varying mu_i for each theta_i
